upstream nextjs_upstream {

    server nextjs-app:3000;

}

 

server {

    listen 80;

    server_name _;  # 모든 도메인 허용 (Cloudflare에서 이미 필터링됨)

 

    # 요청 크기 제한

    client_max_body_size 10M;

 

    # Cloudflare 헤더 처리

    # Cloudflare가 전달하는 실제 클라이언트 IP와 프로토콜 정보

    proxy_set_header X-Real-IP $http_cf_connecting_ip;

    proxy_set_header X-Forwarded-For $http_cf_connecting_ip;

    proxy_set_header X-Forwarded-Proto $http_cf_visitor;

 

    # Next.js로 모든 요청 프록시

    location / {

        proxy_pass http://nextjs_upstream;

        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;

        proxy_set_header Connection 'upgrade';

        proxy_set_header Host $host;

        proxy_cache_bypass $http_upgrade;

 

        # Cloudflare 정보 전달

        proxy_set_header CF-Ray $http_cf_ray;

        proxy_set_header CF-IPCountry $http_cf_ipcountry;

    }

 

    # Next.js 정적 파일 캐싱 (_next/static)

    location /_next/static {

        proxy_pass http://nextjs_upstream;

        proxy_cache_valid 200 60m;

        proxy_cache_bypass $http_cache_control;

        add_header Cache-Control "public, max-age=31536000, immutable";

    }

 

    # 이미지 최적화 캐싱

    location /_next/image {

        proxy_pass http://nextjs_upstream;

        proxy_cache_valid 200 60m;

    }

 

    # 헬스 체크 엔드포인트 (선택사항)

    location /health {

        access_log off;

        return 200 "healthy\n";

        add_header Content-Type text/plain;

    }

}